# Admin API Implementation Guide
**Admitly Platform - Admin CMS Backend**
**Created:** December 15, 2025
**Status:** ‚úÖ Phase 1 COMPLETE - Institution Management

---

## üéØ What Was Built

### Backend Foundation (COMPLETE)
‚úÖ **Admin Authentication Middleware** - Role-based access control
‚úÖ **Admin Schemas** - Pydantic models with validation
‚úÖ **Admin Service Layer** - Business logic for CRUD operations
‚úÖ **Admin Router** - 7 RESTful API endpoints
‚úÖ **Integration** - Wired into FastAPI main app

### API Endpoints Implemented

| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| **POST** | `/api/v1/admin/institutions` | Create new institution | ‚úÖ Admin |
| **GET** | `/api/v1/admin/institutions` | List all institutions (with filters) | ‚úÖ Admin |
| **GET** | `/api/v1/admin/institutions/{id}` | Get single institution | ‚úÖ Admin |
| **PUT** | `/api/v1/admin/institutions/{id}` | Update institution | ‚úÖ Admin |
| **DELETE** | `/api/v1/admin/institutions/{id}` | Soft delete institution | ‚úÖ Admin |
| **PATCH** | `/api/v1/admin/institutions/{id}/status` | Update publish status | ‚úÖ Admin |
| **GET** | `/api/v1/admin/health` | Admin health check | ‚úÖ Admin |

---

## üèóÔ∏è Architecture Overview

### Strategic Design Decisions

**1. Service Layer Pattern**
```
Router ‚Üí Service ‚Üí Database
```
- **Why:** Separates business logic from HTTP layer
- **Benefit:** Easier to test, maintain, and reuse

**2. Admin vs Public Separation**
```
Public API:  /api/v1/institutions  (RLS applied, published only)
Admin API:   /api/v1/admin/institutions  (Bypasses RLS, all statuses)
```
- **Why:** Admin needs access to drafts, archived, and soft-deleted items
- **Security:** Uses `service_role` key with proper role checking

**3. Soft Delete Pattern**
```sql
DELETE ‚Üí UPDATE deleted_at = NOW()
```
- **Why:** Preserve data for audit trail
- **Benefit:** Can recover accidentally deleted institutions

**4. Slug Auto-Generation**
```typescript
"University of Lagos" ‚Üí "university-of-lagos"
```
- **Why:** SEO-friendly URLs
- **Benefit:** Admin doesn't need to manually create slugs

---

## üîê Authentication Flow

### How Admin Authentication Works

```
1. User logs in ‚Üí Gets JWT token from Supabase Auth
2. User calls admin endpoint with token in Authorization header
3. get_current_user() validates JWT with Supabase
4. get_current_admin_user() checks user_profiles.role = 'admin'
5. If admin ‚Üí Allow request
6. If not admin ‚Üí Return 403 Forbidden
```

### Setting Up Admin User

**Step 1: Create user via Supabase Auth**
```sql
-- User is created through normal registration flow
-- OR manually in Supabase dashboard
```

**Step 2: Grant admin role**
```sql
UPDATE user_profiles
SET role = 'admin'
WHERE id = '<user_id>';
```

**Step 3: Test admin access**
```bash
# Get JWT token by logging in
POST /api/v1/auth/login
{
  "email": "admin@admitly.com.ng",
  "password": "secure_password"
}

# Use token for admin endpoints
GET /api/v1/admin/health
Authorization: Bearer <token>
```

---

## üìö API Documentation

### 1. Create Institution

**Endpoint:** `POST /api/v1/admin/institutions`

**Request Body:**
```json
{
  "name": "University of Lagos",
  "short_name": "UNILAG",
  "type": "federal_university",
  "state": "Lagos",
  "city": "Lagos",
  "description": "Premier university in Nigeria",
  "address": "Akoka, Lagos",
  "phone": "+234-1-4932043",
  "email": "info@unilag.edu.ng",
  "website": "https://unilag.edu.ng",
  "year_established": 1962,
  "accreditation_status": "Fully Accredited",
  "verified": true,
  "status": "published"
}
```

**Response:** `201 Created`
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "slug": "university-of-lagos",
  "name": "University of Lagos",
  "short_name": "UNILAG",
  "type": "federal_university",
  "state": "Lagos",
  "city": "Lagos",
  "description": "Premier university in Nigeria",
  "address": "Akoka, Lagos",
  "phone": "+234-1-4932043",
  "email": "info@unilag.edu.ng",
  "website": "https://unilag.edu.ng",
  "logo_url": null,
  "banner_url": null,
  "year_established": 1962,
  "accreditation_status": "Fully Accredited",
  "verified": true,
  "status": "published",
  "program_count": 0,
  "created_at": "2025-12-15T10:00:00Z",
  "updated_at": "2025-12-15T10:00:00Z",
  "deleted_at": null
}
```

**Validation:**
- `name`: Required, 3-200 characters
- `type`: Must be valid enum (federal_university, state_university, etc.)
- `state`: Must be valid Nigerian state (36 states + FCT)
- `email`: Must contain @ symbol
- `year_established`: 1800-2100

**Auto-Generated Fields:**
- `slug`: Generated from name if not provided
- `id`: UUID generated by database
- `created_at`, `updated_at`: Auto-populated

---

### 2. List Institutions

**Endpoint:** `GET /api/v1/admin/institutions`

**Query Parameters:**
- `page` (default: 1) - Page number
- `page_size` (default: 20, max: 100) - Items per page
- `status_filter` - Filter by status (draft, published, archived)
- `search` - Search in name or short_name

**Examples:**
```bash
# Get all institutions (page 1)
GET /api/v1/admin/institutions

# Get drafts only
GET /api/v1/admin/institutions?status_filter=draft

# Search for "university"
GET /api/v1/admin/institutions?search=university

# Get page 2 with 50 items
GET /api/v1/admin/institutions?page=2&page_size=50
```

**Response:** `200 OK`
```json
{
  "data": [
    {
      "id": "...",
      "slug": "university-of-lagos",
      "name": "University of Lagos",
      ...
    }
  ],
  "pagination": {
    "page": 1,
    "page_size": 20,
    "total": 45,
    "total_pages": 3,
    "has_prev": false,
    "has_next": true
  }
}
```

---

### 3. Get Institution by ID

**Endpoint:** `GET /api/v1/admin/institutions/{institution_id}`

**Response:** `200 OK`
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "slug": "university-of-lagos",
  "name": "University of Lagos",
  ...
  "program_count": 120
}
```

**Error:** `404 Not Found`
```json
{
  "detail": "Institution with id 550e8400-e29b-41d4-a716-446655440000 not found"
}
```

---

### 4. Update Institution

**Endpoint:** `PUT /api/v1/admin/institutions/{institution_id}`

**Request Body:** (All fields optional)
```json
{
  "name": "Updated Name",
  "verified": true,
  "status": "published"
}
```

**Response:** `200 OK`
```json
{
  "id": "...",
  "name": "Updated Name",
  "verified": true,
  "status": "published",
  ...
  "updated_at": "2025-12-15T11:00:00Z"
}
```

**Note:** Only provided fields are updated. Other fields remain unchanged.

---

### 5. Delete Institution (Soft Delete)

**Endpoint:** `DELETE /api/v1/admin/institutions/{institution_id}`

**Response:** `200 OK`
```json
{
  "message": "Institution 550e8400-e29b-41d4-a716-446655440000 deleted successfully"
}
```

**What Happens:**
- `deleted_at` timestamp is set to NOW()
- Institution is hidden from public API
- Still visible in admin API
- Can be recovered by setting `deleted_at = NULL`

---

### 6. Update Status

**Endpoint:** `PATCH /api/v1/admin/institutions/{institution_id}/status`

**Request Body:**
```json
{
  "status": "published"
}
```

**Valid Statuses:**
- `draft` - Not visible to public
- `published` - Visible to public
- `archived` - Not visible to public (for old institutions)

**Response:** `200 OK`
```json
{
  "id": "...",
  "status": "published",
  ...
}
```

**Use Cases:**
- Publish draft: `draft` ‚Üí `published`
- Unpublish: `published` ‚Üí `draft`
- Archive: Any status ‚Üí `archived`

---

### 7. Admin Health Check

**Endpoint:** `GET /api/v1/admin/health`

**Response:** `200 OK`
```json
{
  "status": "healthy",
  "message": "Admin access granted",
  "user_id": "user-uuid",
  "user_email": "admin@admitly.com.ng"
}
```

**Purpose:** Verify admin authentication is working

---

## üß™ Testing Guide

### Prerequisites

1. **Backend server running:**
```bash
cd services/api
uvicorn main:app --reload --port 8000
```

2. **Admin user created:**
```sql
-- Set user role to admin in Supabase
UPDATE user_profiles
SET role = 'admin'
WHERE email = 'admin@admitly.com.ng';
```

3. **Get JWT token:**
```bash
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@admitly.com.ng",
    "password": "your_password"
  }'

# Extract access_token from response
TOKEN="<your_token_here>"
```

---

### Test 1: Admin Health Check

```bash
curl -X GET http://localhost:8000/api/v1/admin/health \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with user info

---

### Test 2: Create Institution

```bash
curl -X POST http://localhost:8000/api/v1/admin/institutions \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test University",
    "type": "federal_university",
    "state": "Lagos",
    "city": "Lagos",
    "description": "Test institution for manual data entry",
    "email": "test@test.edu.ng",
    "verified": false,
    "status": "draft"
  }'
```

**Expected:** `201 Created` with institution data
**Check:** `program_count` should be 0 for new institution

---

### Test 3: List Institutions

```bash
curl -X GET http://localhost:8000/api/v1/admin/institutions \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with array of institutions and pagination

---

### Test 4: Update Institution

```bash
# Replace INSTITUTION_ID with actual ID from create response
curl -X PUT http://localhost:8000/api/v1/admin/institutions/INSTITUTION_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "verified": true,
    "status": "published"
  }'
```

**Expected:** `200 OK` with updated institution
**Check:** Only `verified` and `status` should change

---

### Test 5: Update Status

```bash
curl -X PATCH http://localhost:8000/api/v1/admin/institutions/INSTITUTION_ID/status \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "status": "published"
  }'
```

**Expected:** `200 OK`
**Verify:** Institution now appears in public API

---

### Test 6: Get by ID

```bash
curl -X GET http://localhost:8000/api/v1/admin/institutions/INSTITUTION_ID \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with institution details

---

### Test 7: Search Institutions

```bash
curl -X GET "http://localhost:8000/api/v1/admin/institutions?search=test" \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with institutions matching "test"

---

### Test 8: Filter by Status

```bash
curl -X GET "http://localhost:8000/api/v1/admin/institutions?status_filter=draft" \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with only draft institutions

---

### Test 9: Delete Institution

```bash
curl -X DELETE http://localhost:8000/api/v1/admin/institutions/INSTITUTION_ID \
  -H "Authorization: Bearer $TOKEN"
```

**Expected:** `200 OK` with success message
**Verify:** Institution no longer in public API but still in admin API

---

### Test 10: Unauthorized Access

```bash
# Try without token
curl -X GET http://localhost:8000/api/v1/admin/institutions
```

**Expected:** `401 Unauthorized`

```bash
# Try with non-admin user token
curl -X GET http://localhost:8000/api/v1/admin/institutions \
  -H "Authorization: Bearer <non_admin_token>"
```

**Expected:** `403 Forbidden`

---

## üéâ Success Criteria

**Backend Phase 1 is COMPLETE when:**
- ‚úÖ All 7 endpoints respond correctly
- ‚úÖ Admin authentication works (role check)
- ‚úÖ Non-admin users get 403 Forbidden
- ‚úÖ Validation errors return 400 with details
- ‚úÖ Not found returns 404
- ‚úÖ Slug auto-generation works
- ‚úÖ Soft delete preserves data
- ‚úÖ Status update changes visibility

---

## üöÄ Next Steps

### Phase 2: Frontend Admin Portal (Next Session)

**Tasks:**
1. Create admin login page
2. Create institution list page (table with pagination)
3. Create institution form page (create/edit)
4. Add logo upload functionality
5. Wire to backend APIs

**Estimated Time:** 6-8 hours

### Phase 3: Program Management

**Tasks:**
1. Create program CRUD endpoints
2. Add bulk CSV import
3. Frontend program forms

**Estimated Time:** 4-6 hours

---

## üìñ Code Examples

### Using Admin Service in Python

```python
from services.admin_institution_service import AdminInstitutionService
from core.database import get_supabase_admin
from schemas.admin import InstitutionCreateRequest

# Get admin client (bypasses RLS)
supabase = get_supabase_admin()
service = AdminInstitutionService(supabase)

# Create institution
data = InstitutionCreateRequest(
    name="Test University",
    type="federal_university",
    state="Lagos",
    city="Lagos",
    status="draft"
)

institution = await service.create_institution(data)
print(f"Created institution: {institution.id}")

# List all institutions (including drafts)
result = await service.list_institutions(page=1, page_size=20)
print(f"Total institutions: {result['pagination']['total']}")

# Update status
updated = await service.update_status(institution.id, "published")
print(f"Status: {updated.status}")
```

---

## üîç Troubleshooting

### Error: "Admin access denied: User profile not found"
**Cause:** User doesn't have entry in `user_profiles` table
**Solution:** Insert user profile with role='admin'

### Error: "Admin access denied: Insufficient permissions"
**Cause:** User role is not 'admin'
**Solution:** Update user_profiles.role to 'admin'

### Error: "Institution with slug 'xxx' already exists"
**Cause:** Slug conflict
**Solution:** Provide custom slug or modify name

### Error: "State must be one of: ..."
**Cause:** Invalid Nigerian state
**Solution:** Use exact state name from list (e.g., "Lagos" not "lagos")

---

## üìä Database Schema Reference

**Table:** `institutions`

**Key Columns:**
- `id` (uuid) - Primary key
- `slug` (text) - Unique, URL-friendly identifier
- `name` (text) - Institution name
- `type` (enum) - Institution type
- `state` (text) - Nigerian state
- `status` (enum) - draft, published, archived
- `verified` (boolean) - Verification status
- `deleted_at` (timestamp) - Soft delete timestamp

---

**Status:** ‚úÖ Backend Phase 1 COMPLETE
**Next:** Frontend Admin Portal Implementation
**Estimated Path to Launch:** 1-2 days with admin portal + manual data entry

üöÄ **Ready for production deployment and manual data population!**
